{% extends 'base.html' %}
{% block title %}Courriers – {{ patient.nom }} {{ patient.prenom }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Courriers – {{ patient.nom }} {{ patient.prenom }} (DN {{ patient.dn }})</h2>
  <div class="btn-group">
    <a class="btn btn-primary" href="{% url 'courrier_create_for_dn' patient.dn %}">Nouveau courrier</a>
    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <span class="sr-only">Choisir un modèle</span>
    </button>
    <div class="dropdown-menu dropdown-menu-right">
      <a class="dropdown-item" href="{% url 'courrier_create_for_dn' patient.dn %}?type=FOGD">Fibroscopie gastrique</a>
      <a class="dropdown-item" href="{% url 'courrier_create_for_dn' patient.dn %}?type=COLO">Coloscopie</a>
      <a class="dropdown-item" href="{% url 'courrier_create_for_dn' patient.dn %}?type=ECHO">Échographie abdominale</a>
      <a class="dropdown-item" href="{% url 'courrier_create_for_dn' patient.dn %}?type=SYN">Courrier de synthèse</a>
    </div>
  </div>
</div>

<p class="text-muted">Date de naissance : {% if patient.date_naissance %}{{ patient.date_naissance|date:'d/m/Y' }}{% else %}-{% endif %}</p>

{% if courriers %}
  <div class="list-group">
  {% for c in courriers %}
    <div class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-1">{{ c.date_courrier|date:'d/m/Y' }} – {{ c.type_label }}</h5>
        <div>
          <a class="btn btn-sm btn-outline-secondary mr-1" href="{% url 'courrier_pdf' c.pk %}" target="_blank">PDF</a>
          <a class="btn btn-sm btn-outline-info mr-1" href="{% url 'courrier_send_email' c.pk %}">Envoyer</a>
          <a class="btn btn-sm btn-outline-primary mr-1" href="{% url 'courrier_update' c.pk %}">Modifier</a>
          <a class="btn btn-sm btn-outline-danger" href="{% url 'courrier_delete' c.pk %}">Supprimer</a>
        </div>
      </div>
      <div style="white-space: pre-wrap;" class="mt-2">{{ c.corps }}</div>
    </div>
  {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info">Aucun courrier pour ce patient. Vous pouvez en créer un ci‑dessus.</div>
{% endif %}

<a class="btn btn-link mt-3" href="{% url 'patients_detail' patient.dn %}">← Retour à la fiche patient</a>

<script>
  // Fallback: ensure dropdown item clicks always navigate, even if a JS/CSS issue prevents default behavior
  document.addEventListener('DOMContentLoaded', function() {
    var items = document.querySelectorAll('.dropdown-menu a.dropdown-item');
    items.forEach(function(a){
      a.addEventListener('click', function(e){
        // Force navigation explicitly
        window.location.href = a.getAttribute('href');
      });
    });
  });
</script>
{% endblock %}
