{% extends 'base.html' %}
{% block title %}{% if mode == 'update' %}Modifier courrier{% else %}Nouveau courrier{% endif %}{% endblock %}
{% block content %}
<h2>{% if mode == 'update' %}Modifier courrier{% else %}Nouveau courrier{% endif %}</h2>
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="form-row">
    <div class="form-group col-md-3">{{ form.dn.label_tag }} {{ form.dn }}</div>
    <div class="form-group col-md-3">{{ form.nom.label_tag }} {{ form.nom }}</div>
    <div class="form-group col-md-3">{{ form.prenom.label_tag }} {{ form.prenom }}</div>
    <div class="form-group col-md-3">{{ form.date_naissance.label_tag }} {{ form.date_naissance }}</div>
  </div>
  <div class="form-row">
    <div class="form-group col-md-4">{{ form.type_courrier.label_tag }} {{ form.type_courrier }}</div>
  </div>
  <!-- Options spécifiques pour la fiche de consentement -->
  <div class="form-row" id="cons-options" style="display:none;">
    <div class="form-group col-md-6">
      <label for="cons_exam_type">Type d'examen</label>
      <select id="cons_exam_type" class="form-control">
        <option value="">— Sélectionnez —</option>
        <option>gastroscopie et coloscopie sous anesthésie</option>
        <option>gastroscopie et coloscopie sans anesthésie</option>
        <option>gastroscopie avec anesthésie</option>
        <option>gastroscopie sans anesthésie</option>
        <option>coloscopie avec anesthésie</option>
        <option>coloscopie sans anesthésie</option>
        <option>echoendoscopie haute avec anesthésie</option>
      </select>
    </div>
    <div class="form-group col-md-6">
      <label for="cons_exam_date">Date présumée de l'examen</label>
      <input id="cons_exam_date" type="date" class="form-control" />
    </div>
  </div>
  <!-- Options spécifiques pour l'attestation de retour -->
  <div class="form-row" id="atre-options" style="display:none;">
    <div class="form-group col-md-6">
      <label for="atre_accomp">Mode de retour</label>
      <select id="atre_accomp" class="form-control">
        <option value="">— Sélectionnez —</option>
        <option>accompagné(e)</option>
        <option>non accompagné(e)</option>
      </select>
    </div>
  </div>
  <!-- Options biopsies pour FOGD/COLO -->
  <div class="form-row" id="biopsy-options" style="display:none;">
    <div class="form-group col-md-3">
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" id="biopsie_realisee" name="biopsie_realisee" />
        <label class="form-check-label" for="biopsie_realisee">Biopsie réalisée</label>
      </div>
    </div>
    <div class="form-group col-md-9">
      <label for="biopsie_destination">Destination des biopsies</label>
      <select id="biopsie_destination" name="biopsie_destination" class="form-control">
        <option value="">— Sélectionnez —</option>
        <option value="CERBA">CERBA - France</option>
        <option value="CHT">Service anatomo-pathologie - CHT</option>
      </select>
      <small class="form-text text-muted">Un e‑mail de rappel sera envoyé 4 semaines après l'examen.</small>
    </div>
  </div>
  <div class="form-group">{{ form.corps.label_tag }} {{ form.corps }}</div>
  {% comment %} Server-side fallback visibility for photos when eligible types are preselected {% endcomment %}
  <div class="form-row" id="photos-options" {% if form.type_courrier.value == 'FOGD' or form.type_courrier.value == 'COLO' or form.type_courrier.value == 'ECHO' or form.type_courrier.value == 'SYN' %}{% else %}style="display:none;"{% endif %}>
    <div class="form-group col-md-12">
      <label>Photos (max 4, formats JPG/PNG)</label>
      <div class="row">
        <div class="col-3 mb-2">
          <input type="file" name="photo1" accept="image/*" class="form-control-file" />
          <input type="text" name="legend1" class="form-control form-control-sm mt-1" placeholder="Légende 1" />
        </div>
        <div class="col-3 mb-2">
          <input type="file" name="photo2" accept="image/*" class="form-control-file" />
          <input type="text" name="legend2" class="form-control form-control-sm mt-1" placeholder="Légende 2" />
        </div>
        <div class="col-3 mb-2">
          <input type="file" name="photo3" accept="image/*" class="form-control-file" />
          <input type="text" name="legend3" class="form-control form-control-sm mt-1" placeholder="Légende 3" />
        </div>
        <div class="col-3 mb-2">
          <input type="file" name="photo4" accept="image/*" class="form-control-file" />
          <input type="text" name="legend4" class="form-control form-control-sm mt-1" placeholder="Légende 4" />
        </div>
      </div>
      {% if courrier and courrier.photos.all %}
        <div class="mt-2">
          <strong>Photos existantes :</strong>
          <div class="d-flex flex-wrap">
            {% for p in courrier.photos.all|slice:':4' %}
              <div style="width:120px; margin:4px; text-align:center;">
                <img src="{{ p.image.url }}" alt="photo" style="max-width:110px; max-height:110px; display:block; margin:0 auto;" />
                <input type="text" name="legend{{ p.position }}" value="{{ p.legend }}" class="form-control form-control-sm mt-1" placeholder="Légende {{ p.position }}" />
                <label style="font-size:11px;" class="mt-1"><input type="checkbox" name="delete_photo_{{ p.id }}" /> Supprimer</label>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
      <small class="form-text text-muted">Les photos seront ajoutées sur une deuxième page en damier (2x2).</small>
    </div>
  </div>
  <button type="submit" class="btn btn-primary">Enregistrer</button>
  {% if dn %}
    <a href="{% url 'courriers_by_dn' dn %}" class="btn btn-link">Annuler</a>
    <a href="{% url 'patients_detail' dn %}" class="btn btn-link">Retour à la fiche patient</a>
  {% endif %}
  {% if courrier %}
    <a class="btn btn-outline-secondary ml-2" href="{% url 'courrier_pdf' courrier.pk %}" target="_blank">PDF</a>
    <a class="btn btn-outline-info ml-2" href="{% url 'courrier_send_email' courrier.pk %}">Envoyer par e‑mail</a>
  {% endif %}
  </form>

<script>
  (function(){
    function fmtDate(d) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    function getField(id){ return document.getElementById(id); }

    function tplFOGD(){
      return (
        "TECHNIQUE :\n"+
        "Lieu : Clinique PAOFAI, salle 4, Opérateur : Dr. J-A Bronstein\n"+
        "Appareil Fibroscopie N°2 - n° série : 210 31 12\n"+
        "Protocole de désinfection conforme à la circulaire DGH/DH n° 96-236 du 12 avril 1996. L'opérateur s'est assuré de la validation finale du protocole de désinfection : Oui\n"+
        "Préparation : Xylocaïne Gel\n"+
        "Tolérance : Bonne\n\n"+
        "INDICATION : \n\n"+
        "RESULTATS :\n\n"+
        "Œsophage : \n"+
        "- Muqueuse œsophagienne normale sur toute sa longueur\n"+
        "- Ligne Z : 40 cm des arcades dentaires\n\n"+
        "Cardia : Cardia anatomique à 40 cm des arcades dentaires\n\n"+
        "Fundus : \n\n"+
        "Antre : Normal\n\n"+
        "Pylore : Normal\n\n"+
        "Bulbe : Normal\n\n"+
        "Duodénum : Normal\n\n"+
        "Biopsies : Oui / Non\n\n"+
        "CONCLUSION : Fibroscopie oeso-gastro-duodénale normale\n"
      );
    }

    function tplCOLO(){
      return (
        "TECHNIQUE :\n"+
        "Lieu : Clinique PAOFAI, salle 4, Opérateur : Dr. J-A Bronstein\n"+
        "Appareil Fibroscopie N°2 - n° série : 210 31 12\n"+
        "Protocole de désinfection conforme à la circulaire DGH/DH n° 96-236 du 12 avril 1996. L'opérateur s'est assuré de la validation finale du protocole de désinfection : Oui\n"+
        "Préparation : 3 litres de FORTRANS\n"+
        "Score de BOSTON : Colon droit :  3  // Colon transverse :  3  // Colon Gauche - Rectum : 3  // Total : 9 \n"+
        "Tolérance : Bonne\n\n"+
        "INDICATION : \n\n"+
        "RESULTATS :\n\n"+
        "Progression facile dans un colon bien préparé jusque dans le caecum\n\n"+
        "Toucher rectal : normal\n\n"+
        "Marge anale : normale\n\n"+
        "Canal anal : normal\n\n"+
        "Rectum : normal\n\n"+
        "Sigmoide : normal\n\n"+
        "Colon gauche : normal\n\n"+
        "Angle gauche : normal\n\n"+
        "Colon transverse : normal\n\n"+
        "Angle droit : normal\n\n"+
        "Colon droit : normal\n\n"+
        "Caecum : normal\n\n"+
        "Valvule de Bauhin : normal\n\n"+
        "Iléon terminal : normal\n\n"+
        "CONCLUSION : Coloscopie totale normale\n"
      );
    }

    function tplECHO(){
      return (
        "TECHNIQUE :\n"+
        "Lieu : Clinique PAOFAI, Opérateur : Dr. J-A Bronstein\n"+
        "Appareil : Sonde convexe haute résolution\n"+
        "Tolérance : Bonne\n\n"+
        "INDICATION : \n\n"+
        "RÉSULTATS :\n\n"+
        "Foie : Taille et échostructure normales, sans lésion focale visible\n\n"+
        "Voies biliaires : Non dilatées\n\n"+
        "Vésicule biliaire : Parois fines, pas de lithiases\n\n"+
        "Pancréas : Visualisation correcte, échostructure conservée\n\n"+
        "Rate : Taille normale, homogène\n\n"+
        "Reins : Taille conservée, pas d'hydronéphrose, pas de lésion focale\n\n"+
        "Aorte et VCI : Calibre normal, pas d'anévrysme\n\n"+
        "Vessie : Paroi fine, contenu anéchogène\n\n"+
        "Prostate/Utérus-Annexes : Aspect dans les limites de la normale (selon contexte)\n\n"+
        "CONCLUSION : Échographie abdominale normale\n"
      );
    }

  function tplSYN(){
      const nom = (getField('id_nom')?.value || '').trim();
      const prenom = (getField('id_prenom')?.value || '').trim();
      const dna = (getField('id_date_naissance')?.value || '').trim();
      const today = fmtDate(new Date());
      const dnaStr = dna ? dna.split('-').reverse().join('/') : 'XX/XX/XXXX';
      return (
        "Cher collègue,\n\n"+
        `M. (Mme) ${nom} ${prenom}, né(e) le ${dnaStr}, a été hospitalisé(e) dans le service des hospitalisations ambulatoires le ${today} pour dépistage endoscopique sous AG.\n\n`+
        "La gastroscopie est normale. Il n'y a pas d'anomalie des muqueuses duodénale, antrale, fundique et œsophagienne. Aucune biopsie n'a été réalisée.\n\n"+
        "La coloscopie est complète, menée jusque dans le caecum. Le colon est correctement préparé, et toute la muqueuse est examinée. Au retrait du coloscope, il n'a pas été mis en évidence d'anomalie de la muqueuse (caecum, colon droit, colon transverse, colon gauche, sigmoïde et rectum). Il n'y a pas lieu d'envisager un contrôle avant cinq ans, sauf si apparaissent entre‑temps des rectorragies, des douleurs abdominales, ou un trouble du transit.\n\n"+
        "— Variante si polypes —\n"+
        "La coloscopie est complète, menée jusque dans le caecum. Le colon est correctement préparé, et toute la muqueuse est examinée. Au retrait du coloscope, on enlève X polype(s) à la pince biopsique. Il n'y a pas lieu d'envisager un contrôle avant cinq ans, sauf si apparaissent entre‑temps des rectorragies, des douleurs abdominales, ou un trouble du transit.\n\n"+
        "Je te remercie de ta confiance et je reste à ta disposition.\n"
      );
    }

  function tplCONS(){
      const nom = (getField('id_nom')?.value || '').trim();
      const prenom = (getField('id_prenom')?.value || '').trim();
      const dna = (getField('id_date_naissance')?.value || '').trim();
      const dnaStr = dna ? dna.split('-').reverse().join('/') : 'XX/XX/XXXX';
      const exam = (document.getElementById('cons_exam_type')?.value || '').trim() || '[sélection ci‑dessous]';
      const d = document.getElementById('cons_exam_date')?.value || '';
      const dStr = d ? d.split('-').reverse().join('/') : 'JJ/MM/AAAA';
      const today = fmtDate(new Date());
      return (
        "\n\n"+
        `Patient : ${nom} ${prenom}, né(e) le ${dnaStr}\n\n`+
        `Examen prévu : ${exam}\n`+
        `Date présumée de l'examen : ${dStr}\n\n`+
        "Information délivrée au patient :\n"+
        "- Bénéfices attendus de l'examen\n"+
        "- Risques potentiels (hémorragie, perforation, infection, effets de l'anesthésie)\n"+
        "- Alternatives possibles\n"+
        "- Réponses aux questions posées\n\n"+
        "Consentement :\n"+
        "Le patient déclare avoir reçu une information claire, loyale et appropriée, et consent à la réalisation de l'examen sus‑mentionné.\n\n"+
        `Date : ${today}\n`+
        "Signature du patient : __________________________\n\n"
      );
    }

    function tplATRE(){
      const nom = (getField('id_nom')?.value || '').trim();
      const prenom = (getField('id_prenom')?.value || '').trim();
      const dna = (getField('id_date_naissance')?.value || '').trim();
      const dnaStr = dna ? dna.split('-').reverse().join('/') : 'XX/XX/XXXX';
      const dn = (getField('id_dn')?.value || '').trim();
      const accomp = (document.getElementById('atre_accomp')?.value || '').trim() || '[accompagné(e) / non accompagné(e)]';
      const today = fmtDate(new Date());
      return (
        "\n\n"+
        `Je soussigné Docteur Jean-Ariel BRONSTEIN, certifie que l'état de santé de M.(Mme) ${nom} ${prenom}, né(e) le ${dnaStr}, N° DN ${dn} l'autorise à retourner vers son domicile par voie aérienne ${accomp}.\n\n`+
        "Certificat réalisé à la demande de l'intéressé(e) pour servir et remis pour faire valoir ce que de droit.\n\n"+
        `Date : ${today}\n\n`
      );
    }

    const map = { 'FOGD': tplFOGD, 'COLO': tplCOLO, 'ECHO': tplECHO, 'SYN': tplSYN, 'CONS': tplCONS, 'ATRE': tplATRE };
    const typeSel = document.getElementById('id_type_courrier');
    const corps = document.getElementById('id_corps');
    const consRow = document.getElementById('cons-options');
    const atreRow = document.getElementById('atre-options');
    const consExam = document.getElementById('cons_exam_type');
    const consDate = document.getElementById('cons_exam_date');
    const atreAccomp = document.getElementById('atre_accomp');
    const biopsyRow = document.getElementById('biopsy-options');
  const photosRow = document.getElementById('photos-options');
    if (typeSel && corps) {
      typeSel.addEventListener('change', function(){
        const tp = this.value;
        if (map[tp]) {
          if (!corps.value || confirm('Remplacer le texte actuel par le modèle sélectionné ?')) {
            corps.value = map[tp]();
          }
        }
        // Affichage des options spécifiques au consentement
        if (consRow) consRow.style.display = (tp === 'CONS') ? '' : 'none';
        if (atreRow) atreRow.style.display = (tp === 'ATRE') ? '' : 'none';
  if (biopsyRow) biopsyRow.style.display = (tp === 'FOGD' || tp === 'COLO') ? '' : 'none';
  if (photosRow) photosRow.style.display = (tp === 'FOGD' || tp === 'COLO' || tp === 'ECHO' || tp === 'SYN') ? '' : 'none';
      });
      // Réglage initial de la visibilité sans toucher au corps
      const initTp = typeSel.value;
      if (consRow) consRow.style.display = (initTp === 'CONS') ? '' : 'none';
      if (atreRow) atreRow.style.display = (initTp === 'ATRE') ? '' : 'none';
  if (biopsyRow) biopsyRow.style.display = (initTp === 'FOGD' || initTp === 'COLO') ? '' : 'none';
  if (photosRow) photosRow.style.display = (initTp === 'FOGD' || initTp === 'COLO' || initTp === 'ECHO' || initTp === 'SYN') ? '' : 'none';
    }

    // Quand on modifie le type d'examen ou la date pour CONS, on régénère le corps
    function onConsChange(){
      if (typeSel?.value === 'CONS' && map['CONS']) {
        // Ne pas demander confirmation ici: on suppose que l'utilisateur utilise ces champs pour générer le texte
        corps.value = map['CONS']();
      }
    }
    if (consExam) consExam.addEventListener('change', onConsChange);
    if (consDate) consDate.addEventListener('change', onConsChange);

    function onAtreChange(){
      if (typeSel?.value === 'ATRE' && map['ATRE']) {
        corps.value = map['ATRE']();
      }
    }
    if (atreAccomp) atreAccomp.addEventListener('change', onAtreChange);

    // Initialiser l'affichage si on arrive avec type déjà sur CONS (mode update)
    if (consRow && typeSel?.value === 'CONS') {
      consRow.style.display = '';
    }
    if (atreRow && typeSel?.value === 'ATRE') {
      atreRow.style.display = '';
    }
    if (photosRow && (typeSel?.value === 'FOGD' || typeSel?.value === 'COLO' || typeSel?.value === 'ECHO' || typeSel?.value === 'SYN')) {
      photosRow.style.display = '';
    }
  })();
</script>
{% endblock %}
