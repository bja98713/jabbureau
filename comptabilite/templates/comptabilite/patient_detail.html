{% extends 'base.html' %}
{% block title %}Patient {{ patient.nom }} {{ patient.prenom }}{% endblock %}
{% block content %}
<h2>Patient</h2>
<div class="card mb-3">
  <div class="card-body">
    <div class="row">
      <div class="col-md-3"><strong>DN</strong><br>{{ patient.dn }}</div>
      <div class="col-md-3"><strong>Nom</strong><br>{{ patient.nom }}</div>
      <div class="col-md-3"><strong>Prénom</strong><br>{{ patient.prenom }}</div>
      <div class="col-md-3"><strong>Date de naissance</strong><br>{% if patient.date_naissance %}{{ patient.date_naissance|date:'d/m/Y' }}{% endif %}</div>
    </div>
    {% if last_fact %}
    <div class="row mt-3">
      <div class="col-md-12 text-muted">
        Dernière facturation: {{ last_fact.date_acte|date:'d/m/Y' }} (Facture n° {{ last_fact.numero_facture|default:'—' }})
      </div>
    </div>
    {% endif %}
    <div class="mt-3">
      <a class="btn btn-primary" href="{% url 'observation_create_for_dn' patient.dn %}">Nouvelle observation</a>
      <a class="btn btn-success" href="{% url 'facturation_create' %}?dn={{ patient.dn|urlencode }}&nom={{ patient.nom|urlencode }}&prenom={{ patient.prenom|urlencode }}&date_naissance={{ patient.date_naissance|date:'Y-m-d'|urlencode }}">Nouvelle facture</a>
      <a class="btn btn-outline-secondary" href="{% url 'observations_pdf' patient.dn %}" target="_blank">PDF des observations</a>
      <a class="btn btn-outline-info" href="{% url 'observations_send_email' patient.dn %}">Envoyer PDF par e‑mail</a>
      <a class="btn btn-outline-dark" href="{% url 'patient_update' patient.dn %}">Modifier identité</a>
      <a class="btn btn-link" href="{% url 'patients_list' %}">Retour à la liste</a>
    </div>
  </div>
</div>

<h3>Observations</h3>
{% if observations %}
  <div class="list-group">
    {% for obs in observations %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-1">{{ obs.date_observation|date:'d/m/Y' }} – {{ obs.motif_consultation }}</h5>
          <div>
            <a class="btn btn-sm btn-outline-primary mr-1" href="{% url 'observation_update' obs.pk %}">Modifier</a>
            <a class="btn btn-sm btn-outline-danger" href="{% url 'observation_delete' obs.pk %}">Supprimer</a>
          </div>
        </div>
        <p class="mb-1" style="white-space: pre-wrap;">{{ obs.texte_observation }}</p>
        {% if obs.conclusion_observation %}
          <p class="mt-2"><strong>Conclusion:</strong><br><span style="white-space: pre-wrap;">{{ obs.conclusion_observation }}</span></p>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info">Aucune observation pour ce patient.</div>
{% endif %}

<h3 class="mt-4">Historique de facturation</h3>
{% if facturations %}
  <table class="table table-sm table-striped">
    <thead>
      <tr>
        <th>Date acte</th>
        <th>N° facture</th>
        <th>Code</th>
        <th>Total</th>
        <th>Payé</th>
        <th>TP</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for f in facturations %}
      <tr>
        <td>{{ f.date_acte|date:'d/m/Y' }}</td>
        <td>{{ f.numero_facture|default:'—' }}</td>
        <td>{% if f.code_acte %}{{ f.code_acte.code_acte }}{% endif %}</td>
        <td>{{ f.total_acte|default_if_none:"" }}</td>
        <td>{{ f.total_paye|default_if_none:"" }}</td>
        <td>{{ f.tiers_payant|default_if_none:"" }}</td>
        <td>
          <a class="btn btn-sm btn-outline-primary" href="{% url 'facturation_detail' f.pk %}">Voir</a>
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'imprimer_fiche_facturation' f.pk %}">PDF</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="alert alert-light">Aucune facturation trouvée.</div>
{% endif %}
{% endblock %}
